I"ã<<p>This week I attended a workshop at the CDC about last yearâ€™s <a href="https://predict.phiresearchlab.org/flu/index.html">FluSight challenge</a>, a competition that scores weekly real-time predictions about the course of the influenza season. They are planning another round this year and are hoping to increase the number of teams particiating. Stay tuned to <a href="https://predict.phiresearchlab.org/flu/index.html">this site</a> for more info.</p>

<p>At the workshop, I learned about <a href="http://delphi.midas.cs.cmu.edu/">DELPHIâ€™s</a> real-time epidemiological <a href="https://github.com/undefx/delphi-epidata">data API</a>. The API is linked to various data sources on influenza and dengue, including US CDC flu data, Google Flu Trends, and Wikipedia data. There is <a href="https://github.com/undefx/delphi-epidata#the-api">some documentation</a> and <a href="https://github.com/undefx/delphi-epidata#code-samples">minimal examples</a>, and this post documents a more robust and complete example for using the API via R. Iâ€™ll note that the CDCâ€™s influenza data, can also be accessed via the <code class="language-plaintext highlighter-rouge">cdcfluview</code> R package, which Iâ€™m not going to discuss here and I will focus here on accessing some of the other data sources. Hereâ€™s a teaser of this data that you can also interactively explore on the <a href="http://delphi.midas.cs.cmu.edu/epivis/epivis.html">DELPHI EpiVis website</a>:
<img class="img-responsive" width="600" src="/images/blog/epivis.png" /></p>

<!--more-->

<h2 id="setup">Setup</h2>

<p>Letâ€™s start by loading the R script containing the relevant methods needed to access the API.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">source</span><span class="p">(</span><span class="s2">"https://raw.githubusercontent.com/undefx/delphi-epidata/master/code/delphi_epidata.R"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Then, load in two packages that we will use to tidy and plot the data.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">MMWRweek</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<h2 id="dengue-data-from-taiwan-cdc">Dengue data from Taiwan CDC</h2>

<p>Here is some code that pulls data from <a href="http://nidss.cdc.gov.tw/en/">Taiwanâ€™s NIDSS</a>, specifically asking for nationwide data, and data from the central region. A complete list of <a href="https://github.com/undefx/delphi-epidata/blob/master/labels/nidss_regions.txt">regions</a> and <a href="https://github.com/undefx/delphi-epidata/blob/master/labels/nidss_locations.txt">locations</a> are available. Also, Iâ€™ve specified a range of weeks from the first week of 2010 (<code class="language-plaintext highlighter-rouge">201001</code>) to the last week of 2016 (<code class="language-plaintext highlighter-rouge">201653</code>).</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">res</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">Epidata</span><span class="o">$</span><span class="n">nidss.dengue</span><span class="p">(</span><span class="n">locations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="s1">'nationwide'</span><span class="p">,</span><span class="w"> </span><span class="s1">'central'</span><span class="p">),</span><span class="w"> 
                            </span><span class="n">epiweeks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">Epidata</span><span class="o">$</span><span class="nf">range</span><span class="p">(</span><span class="m">201001</span><span class="p">,</span><span class="w"> </span><span class="m">201653</span><span class="p">)))</span><span class="w">
</span></code></pre></div></div>

<p>The above command should pull data down into your current session, but it will be a little bit â€˜list-yâ€™, so here is some code I wrote to clean it up and make it a bit more of a workable dataset in R.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">matrix</span><span class="p">(</span><span class="n">unlist</span><span class="p">(</span><span class="n">res</span><span class="o">$</span><span class="n">epidata</span><span class="p">),</span><span class="w"> </span><span class="n">nrow</span><span class="o">=</span><span class="nf">length</span><span class="p">(</span><span class="n">res</span><span class="o">$</span><span class="n">epidata</span><span class="p">),</span><span class="w"> </span><span class="n">byrow</span><span class="o">=</span><span class="nb">T</span><span class="p">))</span><span class="w">
</span><span class="n">colnames</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">names</span><span class="p">(</span><span class="n">res</span><span class="o">$</span><span class="n">epidata</span><span class="p">[[</span><span class="m">1</span><span class="p">]])[</span><span class="o">!</span><span class="nf">is.null</span><span class="p">(</span><span class="n">res</span><span class="o">$</span><span class="n">epidata</span><span class="p">[[</span><span class="m">1</span><span class="p">]])]</span><span class="w">
</span><span class="n">df</span><span class="o">$</span><span class="n">count</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="nf">as.character</span><span class="p">(</span><span class="n">df</span><span class="o">$</span><span class="n">count</span><span class="p">))</span><span class="w">
</span><span class="n">df</span><span class="o">$</span><span class="n">year</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">substr</span><span class="p">(</span><span class="n">df</span><span class="o">$</span><span class="n">epiweek</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">4</span><span class="p">))</span><span class="w">
</span><span class="n">df</span><span class="o">$</span><span class="n">week</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">substr</span><span class="p">(</span><span class="n">df</span><span class="o">$</span><span class="n">epiweek</span><span class="p">,</span><span class="w"> </span><span class="m">5</span><span class="p">,</span><span class="w"> </span><span class="m">6</span><span class="p">))</span><span class="w">
</span><span class="n">df</span><span class="o">$</span><span class="n">date</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">MMWRweek2Date</span><span class="p">(</span><span class="n">MMWRyear</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df</span><span class="o">$</span><span class="n">year</span><span class="p">,</span><span class="w"> </span><span class="n">MMWRweek</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df</span><span class="o">$</span><span class="n">week</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Note the use of the <code class="language-plaintext highlighter-rouge">MMWRweek2Date()</code> function that gives us a date column in our data frame. And here is a plot of the resulting data.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ggplot</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">date</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="n">location</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">geom_point</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">scale_y_log10</span><span class="p">()</span><span class="w">
</span></code></pre></div></div>

<p><img src="/images/blog/nidss-data.png" alt="" /></p>

<h2 id="wikipedia-data">Wikipedia data</h2>

<p>Letâ€™s try loading some of the Wikipedia data on influenza and other related terms. The article. I think this reflects the number of hits on pages of certain articles, although Iâ€™m not sure.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">res</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">Epidata</span><span class="o">$</span><span class="n">wiki</span><span class="p">(</span><span class="n">articles</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="s2">"influenza"</span><span class="p">,</span><span class="w"> </span><span class="s2">"common_cold"</span><span class="p">,</span><span class="w"> </span><span class="s2">"cough"</span><span class="p">),</span><span class="w">
                    </span><span class="n">epiweeks</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">Epidata</span><span class="o">$</span><span class="nf">range</span><span class="p">(</span><span class="m">201101</span><span class="p">,</span><span class="w"> </span><span class="m">201553</span><span class="p">)))</span><span class="w">
</span><span class="n">df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">matrix</span><span class="p">(</span><span class="n">unlist</span><span class="p">(</span><span class="n">res</span><span class="o">$</span><span class="n">epidata</span><span class="p">),</span><span class="w"> </span><span class="n">nrow</span><span class="o">=</span><span class="nf">length</span><span class="p">(</span><span class="n">res</span><span class="o">$</span><span class="n">epidata</span><span class="p">),</span><span class="w"> </span><span class="n">byrow</span><span class="o">=</span><span class="nb">T</span><span class="p">))</span><span class="w">
</span><span class="n">colnames</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">names</span><span class="p">(</span><span class="n">res</span><span class="o">$</span><span class="n">epidata</span><span class="p">[[</span><span class="m">1</span><span class="p">]])[</span><span class="o">!</span><span class="nf">is.null</span><span class="p">(</span><span class="n">res</span><span class="o">$</span><span class="n">epidata</span><span class="p">[[</span><span class="m">1</span><span class="p">]])]</span><span class="w">
</span><span class="n">df</span><span class="o">$</span><span class="n">count</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="nf">as.character</span><span class="p">(</span><span class="n">df</span><span class="o">$</span><span class="n">count</span><span class="p">))</span><span class="w">
</span><span class="n">df</span><span class="o">$</span><span class="n">year</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">substr</span><span class="p">(</span><span class="n">df</span><span class="o">$</span><span class="n">epiweek</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">4</span><span class="p">))</span><span class="w">
</span><span class="n">df</span><span class="o">$</span><span class="n">week</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">substr</span><span class="p">(</span><span class="n">df</span><span class="o">$</span><span class="n">epiweek</span><span class="p">,</span><span class="w"> </span><span class="m">5</span><span class="p">,</span><span class="w"> </span><span class="m">6</span><span class="p">))</span><span class="w">
</span><span class="n">df</span><span class="o">$</span><span class="n">date</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">MMWRweek2Date</span><span class="p">(</span><span class="n">MMWRyear</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df</span><span class="o">$</span><span class="n">year</span><span class="p">,</span><span class="w"> </span><span class="n">MMWRweek</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df</span><span class="o">$</span><span class="n">week</span><span class="p">)</span><span class="w">
</span><span class="n">ggplot</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">date</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="n">article</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">geom_point</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">geom_smooth</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="m">.1</span><span class="p">,</span><span class="w"> </span><span class="n">se</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p><img src="/images/blog/wiki-data.png" alt="" /></p>

<p>Happy data exploring!</p>

<p><strong>UPDATE</strong>: (2 Sept 2016) Roni Rosenfeld, the head of the DELPHI group at CMU, pointed out and asked me to mention that David Farrow was the force behind the creation of the epidata API and the epivis tool.</p>
:ET